#!/bin/sh
# Search Topdesk assets
set -eu

_this="$0"; _dir=${_this%/*}; _root=${_dir%/tools}
. "$_root/lib/common.sh"; . "$_root/lib/log.sh"; . "$_root/lib/args.sh"; . "$_root/lib/config.sh"

usage() {
  cat <<EOF
Usage: ${TOOLBOX_NAME} assets-search --query QS [--param KEY=VAL]... [--path PATH] [--raw|--pretty]

Calls GET on /tas/api/assetmgmt/assets with the supplied query string.
EOF
}

QS=""; PARAMS=""; PATH_OVERRIDE=""; RAW=0; PRETTY=0

while [ "$#" -gt 0 ]; do
  case "$1" in
    -h|--help)
      usage; exit 0 ;;
    --query)
      req_arg "$@"; QS=$2; shift 2; continue ;;
    --param)
      req_arg "$@"; args_take_param "$2" "${3-}" --param; args_params_append PARAMS "$ARGS_PARAM_KEY" "$ARGS_PARAM_VAL"; shift 2; [ "$ARGS_PARAM_SHIFT" -eq 1 ] && shift; continue ;;
    --param=*)
      args_take_param "${1#--param=}" "" --param; args_params_append PARAMS "$ARGS_PARAM_KEY" "$ARGS_PARAM_VAL"; shift; continue ;;
    --path)
      req_arg "$@"; PATH_OVERRIDE=$2; shift 2; continue ;;
    --raw)
      RAW=1; shift; continue ;;
    --pretty)
      PRETTY=1; shift; continue ;;
    --)
      shift; break ;;
    -*)
      err "unknown option: %s" "$1"; usage >&2; exit 2 ;;
    *)
      break ;;
  esac
done

if [ -z "$QS" ] && [ -z "$PARAMS" ]; then
  err "--query or --param is required"; exit 2;
fi
path=${PATH_OVERRIDE:-/tas/api/assetmgmt/assets}
qs=$(query_apply_params "$QS" "$PARAMS")

if [ -n "$qs" ]; then
  "$_root/tools/call" GET "$path" --query "$qs" ${RAW:+--raw} ${PRETTY:+--pretty}
else
  "$_root/tools/call" GET "$path" ${RAW:+--raw} ${PRETTY:+--pretty}
fi
